(function(){"use strict";const d={version:3,work_date:"2026-01-24 03:50",tables:{setting:{options:{keyPath:"id",autoIncrement:!1},index:[]},tab:{options:{keyPath:"id",autoIncrement:!1},index:[]},diagram:{options:{keyPath:"id",autoIncrement:!1},index:[{key:"byParentID",column:"parentID",options:{unique:!1}}]},log:{options:{keyPath:"id",autoIncrement:!0},index:[]},version_history:{options:{keyPath:"version",autoIncrement:!1},index:[]}}};async function f(a,r){return new Promise((t,e)=>{const n=a.get(r);n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)})}async function w(a,r,t){return new Promise((e,n)=>{if(t==null)return e([]);try{const i=a.index(r).getAll(t);i.onsuccess=()=>{e(i.result)},i.onerror=()=>{console.error(`IndexedDB GetByIndex Error (${r}):`,i.error),n(i.error)}}catch(s){n(s)}})}async function b(a,r){return new Promise((t,e)=>{const n=a.put(r);n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)})}async function D(a,r){const t=r.map(e=>b(a,e));return Promise.all(t)}async function m(a,r){return new Promise((t,e)=>{const n=a.delete(r);n.onsuccess=()=>t(),n.onerror=()=>e(n.error)})}async function p(a,r){const t=r.map(e=>m(a,e));return Promise.all(t)}async function y(a){return new Promise((r,t)=>{const e=a.clear();e.onsuccess=()=>r(),e.onerror=()=>t(e.error)})}function I(){return crypto.randomUUID()}const o={Get:f,GetByIndex:w,Put:b,PutAll:D,Del:m,DelAll:p,Clear:y,CreateUUID:I};async function P(a,{}){const r=a.transaction(["tab","log","setting"],"readwrite"),t={tab:r.objectStore("tab"),log:r.objectStore("log"),setting:r.objectStore("setting")};let e=await o.Get(t.setting,1);e||(await o.Put(t.log,{id:0,code:"tx",ext:"loadSetting. first enter",timestamp:Date.now()}),e={id:1,openTabID:null},await o.Put(t.setting,e));const n=e.openTabID;let s=!1;if(n&&await o.Get(t.tab,n)&&(s=!0),!s){const i=o.CreateUUID();await o.Put(t.tab,{id:i,openDiagramID:"super",favorites:!1,timestamp:Date.now()}),e.openTabID=i,await o.Put(t.setting,e)}return e}async function x(a,{openTabID:r}){const e={setting:a.transaction(["setting"],"readwrite").objectStore("setting")};await o.Put(e.setting,{id:1,openTabID:r})}async function S(a,r){if(!r.tabID)return{tab:null,diagrams:null};const t=a.transaction(["tab","diagram"],"readonly"),e={tab:t.objectStore("tab"),diagram:t.objectStore("diagram")},n=await o.Get(e.tab,r.tabID);if(!n)return{tab:null,diagrams:null};const s=await o.GetByIndex(e.diagram,"byParentID",n.openDiagramID);return{tab:n,diagrams:s}}async function j(a,r){const e={tab:a.transaction(["tab"],"readwrite").objectStore("tab")},n=o.CreateUUID();return await o.Put(e.tab,{id:n,openDiagramID:"super",favorites:!1,timestamp:Date.now()}),n}async function v(a,{id:r,openDiagramID:t,favorites:e}){if(r===null)return;const s={tab:a.transaction(["tab"],"readwrite").objectStore("tab")};await o.Put(s.tab,{id:r,openDiagramID:t,favorites:e,timestamp:Date.now()})}async function h(a,r){const t=o.CreateUUID(),n={diagram:a.transaction(["diagram"],"readwrite").objectStore("diagram")};return await o.Put(n.diagram,{id:t,ui:{},parentID:null,tabID:null}),t}async function k(a,r){if(r.id===null)return;const e={diagram:a.transaction(["diagram"],"readwrite").objectStore("diagram")};await o.Put(e.diagram,r)}const T={loadSetting:P,saveSetting:x,loadTab:S,newTab:j,saveTab:v,newDiagram:h,saveDiagram:k},U=_();self.onmessage=async a=>{const{id:r,type:t,payload:e}=a.data;try{const n=await U,s=T[t];if(!s)throw new Error(`Unknown transaction type: ${t}`);const i=await s(n,e);self.postMessage({id:r,ok:!0,result:i})}catch(n){self.postMessage({id:r,ok:!1,error:n instanceof Error?n.message:String(n)})}};async function _(){return new Promise((a,r)=>{const t=indexedDB.open("diagramDB",d.version);t.onupgradeneeded=e=>{const n=e.target,s=n.result,i=n.transaction;Object.entries(d.tables).forEach(([u,g])=>{let c;s.objectStoreNames.contains(u)?c=i.objectStore(u):c=s.createObjectStore(u,g.options),g.index?.forEach(l=>{c.indexNames.contains(l.key)||c.createIndex(l.key,l.column,l.options)}),u==="version_history"&&c.put({version:e.newVersion,versionPrev:e.oldVersion||null,workDate:d.work_date,timestamp:Date.now()})})},t.onsuccess=()=>a(t.result),t.onerror=()=>r(t.error)})}})();
