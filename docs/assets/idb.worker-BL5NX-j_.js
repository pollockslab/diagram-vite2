(function(){"use strict";const d={version:3,work_date:"2026-01-24 03:50",tables:{setting:{options:{keyPath:"id",autoIncrement:!1},index:[]},tab:{options:{keyPath:"id",autoIncrement:!1},index:[]},diagram:{options:{keyPath:"id",autoIncrement:!1},index:[{key:"byParentID",column:"parentID",options:{unique:!1}}]},log:{options:{keyPath:"id",autoIncrement:!0},index:[]},version_history:{options:{keyPath:"version",autoIncrement:!1},index:[]}}};async function f(o,n){return new Promise((e,t)=>{const r=o.get(n);r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}async function w(o,n,e){return new Promise((t,r)=>{if(e==null)return t([]);try{const i=o.index(n).getAll(e);i.onsuccess=()=>{t(i.result)},i.onerror=()=>{console.error(`IndexedDB GetByIndex Error (${n}):`,i.error),r(i.error)}}catch(s){r(s)}})}async function m(o,n){return new Promise((e,t)=>{const r=o.put(n);r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}async function D(o,n){const e=n.map(t=>m(o,t));return Promise.all(e)}async function b(o,n){return new Promise((e,t)=>{const r=o.delete(n);r.onsuccess=()=>e(),r.onerror=()=>t(r.error)})}async function p(o,n){const e=n.map(t=>b(o,t));return Promise.all(e)}async function y(o){return new Promise((n,e)=>{const t=o.clear();t.onsuccess=()=>n(),t.onerror=()=>e(t.error)})}function I(){return crypto.randomUUID()}const a={Get:f,GetByIndex:w,Put:m,PutAll:D,Del:b,DelAll:p,Clear:y,CreateUUID:I};async function P(o,{}){const n=o.transaction(["tab","log","setting"],"readwrite"),e={tab:n.objectStore("tab"),log:n.objectStore("log"),setting:n.objectStore("setting")};let t=await a.Get(e.setting,1);t||(await a.Put(e.log,{id:0,code:"tx",ext:"loadSetting. first enter",timestamp:Date.now()}),t={id:1,openTabID:null},await a.Put(e.setting,t));const r=t.openTabID;let s=!1;if(r&&await a.Get(e.tab,r)&&(s=!0),!s){const i=a.CreateUUID();await a.Put(e.tab,{id:i,openDiagramID:"super",favorites:!1,timestamp:Date.now()}),t.openTabID=i,await a.Put(e.setting,t)}return t}async function x(o,{openTabID:n}){const t={setting:o.transaction(["setting"],"readwrite").objectStore("setting")};await a.Put(t.setting,{id:1,openTabID:n})}async function S(o,n){if(!n.tabID)return{tab:null,diagrams:null};const e=o.transaction(["tab","diagram"],"readonly"),t={tab:e.objectStore("tab"),diagram:e.objectStore("diagram")},r=await a.Get(t.tab,n.tabID);if(!r)return{tab:null,diagrams:null};const s=await a.GetByIndex(t.diagram,"byParentID",r.openDiagramID);return{tab:r,diagrams:s}}async function j(o,n){const t={tab:o.transaction(["tab"],"readwrite").objectStore("tab")},r=a.CreateUUID();return await a.Put(t.tab,{id:r,openDiagramID:"super",favorites:!1,timestamp:Date.now()}),r}async function v(o,{id:n,openDiagramID:e,favorites:t}){if(n===null)return;const s={tab:o.transaction(["tab"],"readwrite").objectStore("tab")};await a.Put(s.tab,{id:n,openDiagramID:e,favorites:t,timestamp:Date.now()})}async function h(o,n){if(n.id===null)return;const t={diagram:o.transaction(["diagram"],"readwrite").objectStore("diagram")};await a.Put(t.diagram,n)}async function k(o,n){if(n.id===null)return;const t={diagram:o.transaction(["diagram"],"readwrite").objectStore("diagram")};await a.Del(t.diagram,n.id)}const T={loadSetting:P,saveSetting:x,loadTab:S,newTab:j,saveTab:v,saveDiagram:h,deleteDiagram:k},_=U();self.onmessage=async o=>{const{id:n,type:e,payload:t}=o.data;try{const r=await _,s=T[e];if(!s)throw new Error(`Unknown transaction type: ${e}`);const i=await s(r,t);self.postMessage({id:n,ok:!0,result:i})}catch(r){self.postMessage({id:n,ok:!1,error:r instanceof Error?r.message:String(r)})}};async function U(){return new Promise((o,n)=>{const e=indexedDB.open("diagramDB",d.version);e.onupgradeneeded=t=>{const r=t.target,s=r.result,i=r.transaction;Object.entries(d.tables).forEach(([u,g])=>{let c;s.objectStoreNames.contains(u)?c=i.objectStore(u):c=s.createObjectStore(u,g.options),g.index?.forEach(l=>{c.indexNames.contains(l.key)||c.createIndex(l.key,l.column,l.options)}),u==="version_history"&&c.put({version:t.newVersion,versionPrev:t.oldVersion||null,workDate:d.work_date,timestamp:Date.now()})})},e.onsuccess=()=>o(e.result),e.onerror=()=>n(e.error)})}})();
